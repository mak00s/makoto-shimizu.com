---
title: 爆速サイト構築に挑戦 その1.ヘッドレスCMS
date: 2020-08-28 15:30:00
permalink: fast-cms/01-launch-gatsby-on-netlify
categories:
  - ヘッドレスCMSで爆速サイト構築
tags:
  - CMS
  - GTM
  - SEO
thumbnailImage: //res.cloudinary.com/mak00s/f_auto,w_auto:200:800/netlify-gatsby-cms-1.png
---

**CX**や**DX**（デジタルトランスフォーメーション）が流行ってきましたが、ツールの**タグを入れすぎてサイトが重い**、iTPなど**セキュリティ・プライバシー対策が弱い**ので精度が落ちた、なんて状況は避けたいですよね。
「分かりやすいデザイン」「使いやすいUI」は誰でも追求できますが、楽してWordPressを使っているようではパフォーマンスのチューニングに限界があります。**ここ数年、数週間でWebの技術は驚くほど格段に進化**しました。

そこで、将来のWebの進化を見据えて最先端のツールやアプローチを使って、でも（ほぼ）**無料でセキュアで爆速なサイトを最短で構築することに挑戦**します。
<!-- more -->

## ヘッドレスとサーバーサイドでいこう

CMSとタグ管理の発想を根本的に変えることで、爆速セキュアなサイトを実現することにします。

#### 1.CMSはヘッドレスとSPA
まず、CMSはヘッドレスとSPAを組み合わせます。ヘッドレスCMSは2017年あたりから進化が加速し、WordPressのような**動的CMSは言うまでもなく、静的サイトよりもさらに速くて快適なウェブサイトを実現できる**フロントエンド技術「SPA」の流れと合流。ツールや情報も増えたので、だいぶ実用的になりました。

#### 2.タグ管理はサーバーサイド
タグマネジメントは、GDPRの施行やiTPの進化で迷走、イタチごっこが続きましたが、**Google Tag Manager（GTM）のサーバーサイド化**という本命アプローチの無料機能がついにベータ公開され、自前プログラムと自社サーバーによるCookie対策が不要になりました。

#### 3.アナリティクスはイベントベースで一本化
アナリティクスは、**クリックやスクロールのようなイベント**を計測サーバーに送信し、ヒット単位の生データを別のBI（DataポータルやTableau、PowerBI）で**集計・可視化**するのが最近のトレンド。訪問者一人ひとりの行動や心理の変化を追う**カスタマーアナリティクス**的なアプローチも増えてきました。

Adobe Analyticsは、軽量・汎用化した計測用JavaScriptライブラリの新バージョンをリリース。生データの取り出しは少し不便です。

GoogleもFirebaseをベースとした**Google Analyticsの新しいバージョン（Web + App）**をイベント型に切り替えて生ログ保存にも対応し、開発に力を入れています。ログインして利用するレポート画面はおまけのプレビュー機能でしかなく、今後はあまり進化しないでしょう。その代わりにプラットフォームとしての進化が半端ないです。広告連携しないなら360も不要?!


## 実際に既存サイトを再構築してみる

理屈だけの机上の空論にならないよう、実在するWordPressのサイトを再構築することで

* 実現はどれくらい難しい？
* 工数（作業時間）はどれくらいかかる？
* どこまで速くなる？
* 意外なデメリットは？
* 運用は犠牲にならない?

という懸念を具体的にクリアしていきます。

{% alert info %}
本サイトは2018年にWordPressからヘッドレスCMSのhexoに移行し、CDNベースのホスティング「Netlify」と画像管理のGAM「Cloudinary」を採用したので割と高速ですが、SPAではない単なる静的HTMLなので、今回の最新アプローチとツールを組み合わせると、もっと速くなるはず。

今回はWordPressと比較したいので、「[コンセプトダイアグラム公式サイト](https://concept-diagram.com/)」を移行対象にします。そのサイトはチューニングしてないので重いです。WooCommerceのショッピングカートもあるので、さらにShopifyでヘッドレスコマースに挑戦するかも？
{% endalert %}


## Day 1：GatsbyとNetlifyでテンプレサイトを立ち上げる

### まず方針を固める

デザインは後で変更すれば良いので、まず先に**テンプレートを使って開発用サイトを立ち上げる**ことにします。従来の「WordPressをインストールして適当なテーマを適用する」作業に近いイメージです。

**CMSのヘッド側**は、[GatsbyJS](https://www.gatsbyjs.org/)を採用。最近はGatsbyかNuxtの二択でしょう。機能に大差はないので、お好みで。私はReactの方に将来性を感じました。

**ホスティング**は、レガシーなレンタルサーバーをやめて最先端でホットな[Netlify](https://www.netlify.com/)に移行。使っていくうちに進化していくので、Webの将来が垣間見えて「その手があった！」と感動することもしばしば。運用管理も劇的に楽です。

**コンテンツの格納**という意味でのCMSは、Githubを選びました。チームでの同時作業やバージョン管理ができます。

**コンテンツ編集**はNetlify CMSを使い、**マークダウン形式**で記述することで**構造化されたクリーンなHTMLを実現**します。無制限で自由すぎるHTML形式はパフォーマンス低下の原因になるので禁止。

**画像管理**は、リサイズや最適化、Retina対応ができるデジタルアセット管理（DAM）を導入します。DAMは高価なソリューションが多い状況が10年以上続きましたが、今風のモダンで安価なサービスがここ数年で増えてきました。今回は、長年のノウハウに基づく豊富で実用的な機能を持ち、小規模なら無料で使える[Cloudinary](https://cloudinary.com/)を採用します（[本サイトで利用中](/news/site-renewal-2018/)）

### 具体的な作業メモ：まずヘッドレスCMSで雛形サイトを構築

早速作業スタートです。

Netlify+Gatsby+Cloudinaryの組み合わせの場合、[Netlifyが提供するテンプレ](https://github.com/netlify-templates/gatsby-starter-netlify-cms)を使うと、１クリックでインストールできます。

「**Deploy to netlify**」ボタンをクリックし、Githubのリポジトリ名を変更して「**Save and deploy**」ボタンをクリック。

<img src="//res.cloudinary.com/mak00s/f_auto,w_auto:200:800/netlify-gatsby-deploy-1.png" alt="" sizes="100vw" />

リポジトリ作成とNetlify接続設定、デプロイまでが一気に完了し、仮ドメインでサイトが立ち上がります。

<img src="//res.cloudinary.com/mak00s/f_auto,w_auto:200:800/netlify-gatsby-deploy-2.png" alt="" sizes="100vw" />

{% alert info %}
[デフォルト状態の架空サイト](https://gatsby-netlify-cms.netlify.app/)を開いて、いろいろクリックしてみてください。
SPAなので、最初のページを開いた時点で他のページのコンテンツも読み込んだり、リロードせずにコンテンツを書き換えたりでき、劇的に速いです。ページごとにURLがちゃんと切り替わります。SEOもスマホ最適化も完璧。
{% endalert %}

#### CMSに自分を追加

いくつかのメールがNetlifyで登録したメールアドレスに届きますが、そのうち「**You've been invited to join xxx.netlify.app**」という件名のメールだけ、対応が必要です。

と言っても本文中の「**Accept the invite**」をクリックし、Netlifyのアカウントでログインするだけ。CMS用のパスワードを指定すると登録が完了し、CMS管理画面が開きます。

<img src="//res.cloudinary.com/mak00s/f_auto,w_auto:200:800/netlify-gatsby-cms-1.png" alt="" sizes="100vw" />

テンプレを使ったので、ダミーの珈琲屋サイトのコンテンツがいくつか投稿済みになっています。

#### Netlifyでサイト名とドメインを変更

次に、Netlify管理画面のSettingsで設定を変更します。デザインやコンテンツはその後で。

**General＞Site detailsでサイト名を変更**
これはサイトに表示されない**管理上のサイト名**なので、半角英数字で指定します。変更すると仮ドメインも合わせて変更されます。今回は「concept-diagram」にしました。

**Domain managementでカスタムドメインを指定**
本番サイトはそのままで作業を進めてから切り替えたいので、仮のドメイン「netlify.concept-diagram.com」を指定しました。いずれ必要になるので、ついでに**IPv6**も有効化。
NetlifyのDNSサーバーを使う場合は、Let's Encryptの**無料SSL証明書も自動でインストール**されます。

**Build & Deploy＞Snippet injectionでGTMタグを挿入**

Netlifyは**デプロイ（本番リリース）時に自動でタグを入れてくれる**ので、HTMLにタグを入れる必要はありません。
場所はbodyではなくheadを選び、GTMのタグを入れます。

JavaScriptが動かないような特殊な環境ではほとんどのタグは正常動作しないので、GTMのnoscriptの方のタグは省略。

### ここまでで約２時間

慣れると１時間で終わります。
NetlifyやGitHubが初めてで、ドメインも新規に取得する場合は、半日くらいでしょうか。

次回は[サーバーサイドのGTMとGoogle Analyticsを最新方式でスマートに導入](/news/fast-cms/02-server-side-gtm/)します。